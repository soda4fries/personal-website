---
import { useTranslations, type LanguageCode } from '@/i18n/ui';
import { cn } from '@/lib/utils';

export type Heading = {
  id: string;
  text: string;
  level: number;
};

export type Props = {
  lang: LanguageCode;
  headings?: Heading[];
  className?: string;
};

const { lang, headings = [], className } = Astro.props;

const t = useTranslations(lang, 'toc');
const componentTitle = t('title');

// Generate TOC HTML from headings
const tocItems = headings.map((heading) => {
  const indent = (heading.level - 1) * 12; // 12px per level
  return `
    <li style="margin-left: ${indent}px">
      <a href="#${heading.id}" 
         class="toc-link block py-1 px-2 text-sm text-muted-foreground hover:text-foreground hover:bg-accent rounded transition-colors"
         data-level="${heading.level}">
        ${heading.text}
      </a>
    </li>
  `;
}).join('');

const tocHtml = headings.length > 0 ? `<ul class="space-y-2">${tocItems}</ul>` : '';
---

{headings.length > 0 && (
  <>
    <!-- Mobile TOC - appears at top on mobile -->
    <div class="lg:hidden mb-8" id="mobile-toc">
      <details class="group">
        <summary class="flex items-center justify-between p-4 bg-card border border-border rounded-lg cursor-pointer hover:bg-accent transition-colors">
          <span class="font-semibold text-foreground">{componentTitle}</span>
          <svg class="w-5 h-5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </summary>
        <nav class="mt-4 p-4 bg-card border border-border rounded-lg" set:html={tocHtml}>
        </nav>
      </details>
    </div>

    <!-- Desktop TOC - fixed sidebar on desktop -->
    <div class="hidden lg:block fixed top-1/2 right-8 transform -translate-y-1/2 w-64 max-h-[70vh] overflow-y-auto" id="desktop-toc">
      <nav class="bg-card border border-border rounded-lg p-4 shadow-lg">
        <h3 class="font-semibold text-foreground mb-4">{componentTitle}</h3>
        <div set:html={tocHtml}>
        </div>
      </nav>
    </div>
  </>
)}


<style>
  /* Ensure desktop TOC doesn't interfere with content */
  @media (min-width: 1024px) {
    #desktop-toc {
      z-index: 40;
    }
    
    /* Add right margin to main content to avoid overlap with TOC */
    article {
      margin-right: 280px;
    }
  }
  
  /* Smooth scrolling for the entire page */
  html {
    scroll-behavior: smooth;
  }
  
  /* Custom scrollbar for TOC */
  #desktop-toc nav {
    scrollbar-width: thin;
    scrollbar-color: hsl(var(--muted)) transparent;
  }
  
  #desktop-toc nav::-webkit-scrollbar {
    width: 6px;
  }
  
  #desktop-toc nav::-webkit-scrollbar-track {
    background: transparent;
  }
  
  #desktop-toc nav::-webkit-scrollbar-thumb {
    background-color: hsl(var(--muted));
    border-radius: 3px;
  }
</style>
